name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up Python (for backend/logger tests)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # 3. Install dependencies (backend + logger)
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install -r logger/requirements.txt

      # 4. Run tests (you can keep it minimal for now)
      - name: Run tests
        run: |
          pytest || echo "No tests yet"

  docker:
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 5. Log in to DockerHub
      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. Build & push images (backend, frontend, logger)
      - name: Build & push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/backend:latest

      - name: Build & push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/frontend:latest

      - name: Build & push Logger
        uses: docker/build-push-action@v4
        with:
          context: ./logger
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/logger:latest

  alerts:
    needs: docker
    runs-on: ubuntu-latest
    if: failure() # runs only if previous jobs fail

    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": ":rotating_light: CI/CD pipeline *failed*!\n\nRepository: `${{ github.repository }}`\nBranch: `${{ github.ref }}`\nWorkflow: `${{ github.workflow }}`\nActor: `${{ github.actor }}`\nRun Details: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here to see logs>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

   

    #   # OR Email Alert Example
    #   - name: Send Email
        # if: failure()
    #     uses: dawidd6/action-send-mail@v3
    #     with:
    #       server_address: smtp.gmail.com
    #       server_port: 465
    #       username: ${{ secrets.EMAIL_USER }}
    #       password: ${{ secrets.EMAIL_PASS }}
    #       subject: "ðŸš¨ CI/CD Pipeline Failed"
    #       to: your-email@example.com
    #       from: GitHub Actions <noreply@github.com>
    #       body: "Pipeline failed for ${{ github.repository }} on branch ${{ github.ref }}."
